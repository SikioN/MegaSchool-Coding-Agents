# Руководство по настройке и деплою

## 1. Как получить OpenAI API Key

> **Важно**: Для пользователей из РФ доступ к OpenAI ограничен. Потребуется VPN и карта иностранного банка.

1.  **VPN**: Включите VPN (США, Европа).
2.  **Регистрация**: Перейдите на [platform.openai.com](https://platform.openai.com/) и зарегистрируйтесь (Sign Up).
3.  **Привязка карты**:
    *   Перейдите в `Settings` -> `Billing`.
    *   Нажмите `Add payment details`.
    *   Введите данные зарубежной карты (Visa/Mastercard, не РФ).
    *   Пополните баланс (минимум $5).
4.  **Создание ключа**:
    *   Перейдите в [API Keys](https://platform.openai.com/api-keys).
    *   Нажмите `Create new secret key`.
    *   Дайте имя (например, `code-agent`).
    *   **Скопируйте ключ**. Он показывается один раз. Сохраните его в безопасном месте.

### Альтернатива (YandexGPT)

1.  **Создайте Яндекс ID**, если его нет.
2.  Перейдите в [Консоль управления Yandex Cloud](https://console.cloud.yandex.ru/).
3.  **Создайте платежный аккаунт**:
    *   Активируйте пробный период или привяжите карту.
4.  **Создайте каталог** (folder):
    *   Зайдите в облако, нажмите "Создать каталог", дайте имя (например, `default`).
5.  **Создайте сервисный аккаунт**:
    *   В каталоге перейдите в раздел "Сервисные аккаунты".
    *   Нажмите "Создать сервисный аккаунт".
    *   Имя: `im-chooser` (или любое другое).
    *   **Роли**: Добавьте роль `ai.languageModels.user`. Это критически важно для доступа к GPT.
6.  **Получите API Key**:
    *   Нажмите на созданный сервисный аккаунт.
    *   В блоке "API-ключи" (или через CLI) создайте новый API-ключ.
    *   **Сохраните его**. Он начинается на `AQVN...`.
7.  **Получите ID каталога (Folder ID)**:
    *   Он понадобится для заголовка `x-folder-id` (хотя при использовании API-ключа сервисного аккаунта часто достаточно только ключа, но лучше иметь под рукой).

Используйте этот API Key как `LLM_API_KEY`, а `LLM_BASE_URL` нужно будет настроить на `https://llm.api.cloud.yandex.net/foundationModels/v1`.

## 2. Инструкция по деплою в Yandex.Cloud

Мы реализуем схему **Docker on VM** (Виртуальная машина с Docker), так как это самый надежный и простой способ запустить `docker-compose`.

### Шаг 1: Подготовка в Yandex Cloud Console
1.  Перейдите в [console.cloud.yandex.ru](https://console.cloud.yandex.ru/).
2.  Создайте новый каталог (Folder), например `coding-agent-prod`.
3.  **Создайте Service Account** (Сервисный аккаунт) для GitHub Actions:
    *   Имя: `gh-actions-deployer`.
    *   Роли: `compute.editor`, `container-registry.editor`, `vpc.publicAdmin`.
    *   Создайте **авторизованный ключ** (JSON) для этого аккаунта и скачайте его.

### Шаг 2: Создание Container Registry (Опционально)
Если мы хотим хранить свои Docker-образы приватно:
1.  В консоли выберите сервис **Container Registry**.
2.  Создайте реестр, например `agent-registry`.
3.  Запомните его ID / URL.

### Шаг 3: Настройка GitHub Repository Secrets
В вашем GitHub репозитории перейдите в `Settings` -> `Secrets and variables` -> `Actions` и добавьте:

*   `YC_SA_JSON`: Содержимое JSON-файла ключа сервисного аккаунта.
*   `YC_FOLDER_ID`: ID вашего каталога.
*   `VM_SSH_KEY`: Ваш *приватный* SSH ключ (для подключения к VM). Вы должны добавить *публичный* ключ на VM при создании.
*   `GH_TOKEN`: Ваш Personal Access Token (Classic) для работы агента.
*   `LLM_API_KEY`: Ваш ключ OpenAI или YandexGPT.

### Шаг 4: Развертывание (Автоматическое или Ручное)

**Вариант А: Ручной запуск (Быстро)**
1.  Создайте VM в Yandex Cloud (Ubuntu 22.04).
    *   В блоке "Доступ" вставьте свой SSH public key.
2.  Подключитесь по SSH: `ssh yc-user@<IP-адрес>`.
3.  Установите Docker:
    ```bash
    curl -fsSL https://get.docker.com | sh
    ```
4.  Склонируйте репозиторий:
    ```bash
    git clone <ВАШ_REPO_URL> app
    cd app
    ```
5.  Создайте файл `.env` с ключами:
    ```bash
    echo "LLM_API_KEY=sk-..." > .env
    echo "GH_TOKEN=ghp-..." >> .env
    ```
6.  Запустите:
    ```bash
    docker compose up -d
    ```

**Вариант Б: Полная автоматизация через GitHub Actions (Terraform)**
(Это будет реализовано в коде, который я сейчас создам).
Мы добавим workflow, который будет обновлять контейнеры на сервере при пуше в main.
